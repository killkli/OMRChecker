# Stage 4: 答案標記檢測與解析 - 測試指南

## 功能概述

Stage 4 實現了 OMR 系統的核心功能 - 答案標記檢測與解析，包含以下核心功能：

1. **模板載入與解析** - 載入 JSON 格式的答案卡模板
2. **標記位置計算** - 根據模板產生所有標記的預期位置
3. **填充率計算** - 計算每個標記的黑色像素比例
4. **答案判定** - 根據填充率閾值判斷是否已填塗
5. **答案解析** - 將填塗的標記轉換為答案
6. **自動評分** - 對比標準答案並計算分數
7. **視覺化顯示** - 在答案卡上標記答對（綠色）、答錯（紅色）

---

## 快速開始

### 1. 啟動本地伺服器

```bash
cd /Users/johnchen/AICoding/OMRChecker/serverless_web
python3 -m http.server 8000
```

### 2. 開啟測試頁面

有兩種測試方式：

**方式一：主應用程式測試**
- URL: http://localhost:8000/
- 自動執行完整流程（上傳 → 透視校正 → 答案檢測 → 評分）

**方式二：獨立測試頁面**
- URL: http://localhost:8000/tests/test-answer-detection.html
- 提供更詳細的測試環境和日誌輸出

---

## 測試準備

### 產生測試用答案卡

**方式一：使用答案卡產生器**

1. 開啟 http://localhost:8000/tools/generate-test-sheet.html
2. 選擇填答模式：
   - 「產生空白答案卡」- 未填答的答案卡
   - 「產生已填答答案卡」- 按預設答案填答（對應模板標準答案）
   - 「全 A / 全 B / 全 C / 全 D」- 所有題目填同一選項
   - 「ABCD 循環」- 依序填 A、B、C、D
   - 「隨機填答」- 隨機產生答案
3. 點擊「下載答案卡」儲存為 JPG 檔案

**方式二：使用真實答案卡**

- 使用現有的 `serverless_web/samples/test-sheet.jpg`
- 或拍攝/掃描真實的答案卡（需有四個角落標記）

---

## 測試案例

### Test Case 1: 完全正確答案

**目的：** 驗證系統能正確識別所有正確答案並給予滿分

**步驟：**
1. 使用答案卡產生器產生「已填答答案卡」（對應預設答案）
2. 上傳到測試頁面
3. 點擊「執行完整測試」

**預期結果：**
- ✅ 答對題數：20/20
- ✅ 分數：100/100 (100%)
- ✅ 所有標記顯示為綠色

---

### Test Case 2: 部分錯誤答案

**目的：** 驗證系統能正確識別錯誤答案

**步驟：**
1. 產生「全 A」答案卡
2. 上傳並執行測試

**預期結果：**
- ✅ 答對題數：5/20 (根據模板，題 1, 5, 9, 13, 17 為 A)
- ✅ 分數：25/100 (25%)
- ✅ 正確答案顯示綠色，錯誤答案顯示紅色

---

### Test Case 3: 隨機填答

**目的：** 驗證系統對不同答案組合的處理能力

**步驟：**
1. 產生「隨機填答」答案卡
2. 上傳並執行測試
3. 檢查控制台輸出的詳細結果

**預期結果：**
- ✅ 每題的答案正確解析
- ✅ 分數計算正確
- ✅ 視覺化標記準確

---

### Test Case 4: 未填答題目

**目的：** 驗證系統對未作答題目的處理

**步驟：**
1. 產生空白答案卡
2. 上傳並執行測試

**預期結果：**
- ✅ 答對題數：0/20
- ✅ 分數：0/100 (0%)
- ✅ 未作答題數：20
- ✅ 所有標記顯示為灰色

---

### Test Case 5: 複選題檢測

**目的：** 驗證系統能檢測出複選錯誤

**步驟：**
1. 手動修改測試答案卡，在同一題填塗多個選項
2. 上傳並執行測試

**預期結果：**
- ✅ 該題被標記為「複選」狀態 (status: 'multiple')
- ✅ 計為答錯
- ✅ 控制台顯示「Q1: A,B (正確答案: A) ❌」

---

### Test Case 6: 不同傾斜角度

**目的：** 驗證透視校正與答案檢測的組合

**步驟：**
1. 將答案卡旋轉 15° 拍照
2. 上傳並執行測試

**預期結果：**
- ✅ 透視校正成功
- ✅ 答案檢測正常運作
- ✅ 分數計算正確

---

## 技術細節

### 模板格式說明

`templates/default-template.json` 的關鍵欄位：

```json
{
  "bubbles": {
    "diameter": 32,
    "fillThreshold": 0.4  // 填充率 ≥ 40% 視為已填塗
  },
  "layout": {
    "regions": [
      {
        "origin": { "x": 100, "y": 300 },
        "questions": { "start": 1, "end": 10, "gap": 65 },
        "options": { "values": ["A", "B", "C", "D"], "gap": 80 }
      }
    ]
  },
  "answerKey": {
    "1": "A", "2": "B", ...
  }
}
```

### 填充率閾值調整

如果檢測結果不準確，可調整 `fillThreshold`：

- **太靈敏（誤判為已填）** → 提高閾值（例如 0.5 或 0.6）
- **不夠靈敏（漏判）** → 降低閾值（例如 0.3）

### 標記位置計算

系統根據模板自動計算每個標記的位置：

```
標記位置 X = origin.x + (選項索引 × options.gap)
標記位置 Y = origin.y + (題號索引 × questions.gap)
```

---

## 驗證檢查清單

執行測試時，請確認以下項目：

### 功能正確性
- [ ] 模板成功載入，控制台顯示「✅ 模板載入成功」
- [ ] 產生正確數量的標記位置（預設 20 題 × 4 選項 = 80 個標記）
- [ ] 填充率計算正確（可在控制台查看每個標記的 fillRatio）
- [ ] 答案解析正確（對比學生答案與標準答案）
- [ ] 分數計算正確（答對題數 × 每題分數）

### 視覺化檢查
- [ ] 綠色圓圈標記答對的選項
- [ ] 紅色圓圈標記答錯的選項
- [ ] 灰色圓圈標記未填塗的選項
- [ ] 圓圈位置準確對準標記

### 邊界條件
- [ ] 處理空白答案卡（全部未作答）
- [ ] 處理全對答案卡（滿分）
- [ ] 處理複選情況（視為答錯）
- [ ] 處理不同傾斜角度的答案卡

---

## 常見問題

### Q1: 為什麼有些標記沒有被檢測到？

**可能原因：**
1. 填塗不夠深/面積不足 → 降低 `fillThreshold`
2. 透視校正失敗 → 檢查四個角落標記是否清晰
3. 模板座標不準確 → 調整模板的 `origin` 和 `gap` 參數

**解決方案：**
開啟 Canvas「二值化」檢視，確認標記是否清晰可見。

---

### Q2: 為什麼分數計算不正確？

**檢查步驟：**
1. 開啟瀏覽器控制台（F12）
2. 查看「OMR 評分結果」區塊
3. 逐題核對學生答案與正確答案
4. 確認模板的 `answerKey` 設定正確

---

### Q3: 如何自訂答案卡模板？

1. 複製 `templates/default-template.json`
2. 修改 `layout.regions` 的座標和間距
3. 在 `app.js` 中修改模板載入路徑
4. 使用測試頁面驗證新模板

**建議工具：** 使用影像編輯軟體（如 GIMP）測量實際座標

---

## 效能指標

在現代瀏覽器（Chrome/Firefox）上的預期效能：

| 項目 | 預期時間 |
|------|---------|
| 模板載入 | < 100ms |
| 標記位置計算 | < 50ms |
| 填充率計算（80 個標記） | < 500ms |
| 答案解析 | < 10ms |
| 分數計算 | < 10ms |
| 視覺化繪製 | < 200ms |
| **總計** | **< 1 秒** |

---

## 已知限制

1. **單一模板：** 目前僅支援 20 題四選一，未來可擴展為多模板支援
2. **圓形標記：** 目前針對圓形標記最佳化，方形標記需調整檢測參數
3. **固定布局：** 模板採用固定座標，不支援自動佈局檢測
4. **單選題：** 複選題會被標記為錯誤，不支援部分給分

---

## 下一步改進

1. **模板編輯器：** 視覺化的模板編輯工具
2. **多模板支援：** 支援不同題數和選項數的答案卡
3. **自動對齊：** 自動檢測標記位置，無需手動設定座標
4. **結果匯出：** CSV/JSON 格式的評分結果匯出
5. **批次處理：** 一次處理多張答案卡（Web Workers）

---

**建立日期**: 2025-10-05
**版本**: 1.0.0
**測試人員**: engineer-agent
