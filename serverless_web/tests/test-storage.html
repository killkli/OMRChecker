<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB Storage 測試 - OMR Checker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }

        .test-section {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 0.5rem;
        }

        h2 {
            color: #666;
            margin-top: 0;
        }

        .status {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            font-weight: bold;
        }

        .status.pending {
            background: #FFF3CD;
            color: #856404;
        }

        .status.running {
            background: #D1ECF1;
            color: #0C5460;
        }

        .status.success {
            background: #D4EDDA;
            color: #155724;
        }

        .status.error {
            background: #F8D7DA;
            color: #721C24;
        }

        button {
            padding: 0.75rem 1.5rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin: 0.25rem 0;
            padding: 0.25rem;
        }

        .log-entry.info { color: #0C5460; }
        .log-entry.success { color: #155724; }
        .log-entry.error { color: #721C24; }
        .log-entry.warn { color: #856404; }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .results-table th,
        .results-table td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }

        .results-table th {
            background: #4CAF50;
            color: white;
        }

        .thumbnail {
            max-width: 100px;
            max-height: 100px;
        }
    </style>
</head>
<body>
    <h1>🧪 IndexedDB Storage 測試</h1>

    <!-- 測試 1: 資料庫初始化 -->
    <div class="test-section">
        <h2>測試 1: 資料庫初始化</h2>
        <div id="test1-status" class="status pending">等待測試</div>
        <button onclick="runTest1()">執行測試</button>
        <div id="test1-log" class="log"></div>
    </div>

    <!-- 測試 2: 儲存單筆結果 -->
    <div class="test-section">
        <h2>測試 2: 儲存單筆結果</h2>
        <div id="test2-status" class="status pending">等待測試</div>
        <button onclick="runTest2()">執行測試</button>
        <div id="test2-log" class="log"></div>
    </div>

    <!-- 測試 3: 儲存 10 筆結果並讀取 -->
    <div class="test-section">
        <h2>測試 3: 儲存 10 筆結果並讀取</h2>
        <div id="test3-status" class="status pending">等待測試</div>
        <button onclick="runTest3()">執行測試</button>
        <div id="test3-log" class="log"></div>
        <div id="test3-results"></div>
    </div>

    <!-- 測試 4: 影像 Blob 儲存與還原 -->
    <div class="test-section">
        <h2>測試 4: 影像 Blob 儲存與還原</h2>
        <div id="test4-status" class="status pending">等待測試</div>
        <input type="file" id="test4-file" accept="image/*">
        <button onclick="runTest4()">執行測試</button>
        <div id="test4-log" class="log"></div>
        <div id="test4-results"></div>
    </div>

    <!-- 測試 5: 刪除單筆記錄 -->
    <div class="test-section">
        <h2>測試 5: 刪除單筆記錄</h2>
        <div id="test5-status" class="status pending">等待測試</div>
        <button onclick="runTest5()">執行測試</button>
        <div id="test5-log" class="log"></div>
    </div>

    <!-- 測試 6: 刪除所有記錄 -->
    <div class="test-section">
        <h2>測試 6: 刪除所有記錄</h2>
        <div id="test6-status" class="status pending">等待測試</div>
        <button onclick="runTest6()">執行測試</button>
        <div id="test6-log" class="log"></div>
    </div>

    <!-- 測試 7: 模板儲存與讀取 -->
    <div class="test-section">
        <h2>測試 7: 模板儲存與讀取</h2>
        <div id="test7-status" class="status pending">等待測試</div>
        <button onclick="runTest7()">執行測試</button>
        <div id="test7-log" class="log"></div>
    </div>

    <!-- 測試 8: 資料持久化測試 -->
    <div class="test-section">
        <h2>測試 8: 資料持久化測試</h2>
        <p>此測試需要手動執行：</p>
        <ol>
            <li>執行測試 3 儲存 10 筆資料</li>
            <li>關閉瀏覽器分頁</li>
            <li>重新開啟此頁面</li>
            <li>點擊「驗證資料」按鈕</li>
        </ol>
        <div id="test8-status" class="status pending">等待測試</div>
        <button onclick="runTest8()">驗證資料</button>
        <div id="test8-log" class="log"></div>
    </div>

    <!-- 執行所有測試 -->
    <div class="test-section">
        <h2>🚀 執行所有測試</h2>
        <button onclick="runAllTests()" style="background: #2196F3;">執行全部測試</button>
        <button onclick="clearAllData()" style="background: #f44336;">清空所有資料</button>
    </div>

    <script src="../assets/js/storage.js"></script>
    <script>
        // 測試工具函數
        function log(testId, message, type = 'info') {
            const logDiv = document.getElementById(`${testId}-log`);
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setStatus(testId, status, message) {
            const statusDiv = document.getElementById(`${testId}-status`);
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = message;
        }

        // 建立測試用影像 Blob
        function createTestImageBlob() {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');

                // 繪製簡單圖案
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(0, 0, 200, 200);
                ctx.fillStyle = 'white';
                ctx.font = '40px Arial';
                ctx.fillText('TEST', 50, 100);

                canvas.toBlob(resolve, 'image/png');
            });
        }

        // 測試 1: 資料庫初始化
        async function runTest1() {
            const testId = 'test1';
            setStatus(testId, 'running', '測試進行中...');
            log(testId, '開始測試資料庫初始化', 'info');

            try {
                const storage = new OMRStorage();
                await storage.init();

                log(testId, '✓ 資料庫初始化成功', 'success');
                log(testId, `資料庫名稱: ${storage.DB_NAME}`, 'info');
                log(testId, `資料庫版本: ${storage.DB_VERSION}`, 'info');

                setStatus(testId, 'success', '✓ 測試通過');
            } catch (error) {
                log(testId, `✗ 錯誤: ${error.message}`, 'error');
                setStatus(testId, 'error', '✗ 測試失敗');
            }
        }

        // 測試 2: 儲存單筆結果
        async function runTest2() {
            const testId = 'test2';
            setStatus(testId, 'running', '測試進行中...');
            log(testId, '開始測試儲存單筆結果', 'info');

            try {
                const storage = new OMRStorage();
                await storage.init();

                const imageBlob = await createTestImageBlob();

                const testResult = {
                    originalImageBlob: imageBlob,
                    processedImageBlob: imageBlob,
                    answers: { 1: 'A', 2: 'B', 3: 'C' },
                    score: 85,
                    templateName: 'default',
                    metadata: { testName: 'Test 2' }
                };

                log(testId, '建立測試資料...', 'info');
                const id = await storage.saveResult(testResult);

                log(testId, `✓ 儲存成功，ID: ${id}`, 'success');

                // 讀取剛儲存的資料
                const saved = await storage.getResultById(id);
                log(testId, `✓ 讀取成功`, 'success');
                log(testId, `分數: ${saved.score}`, 'info');
                log(testId, `模板: ${saved.templateName}`, 'info');

                setStatus(testId, 'success', '✓ 測試通過');
            } catch (error) {
                log(testId, `✗ 錯誤: ${error.message}`, 'error');
                setStatus(testId, 'error', '✗ 測試失敗');
            }
        }

        // 測試 3: 儲存 10 筆結果並讀取
        async function runTest3() {
            const testId = 'test3';
            setStatus(testId, 'running', '測試進行中...');
            log(testId, '開始測試儲存 10 筆結果', 'info');

            try {
                const storage = new OMRStorage();
                await storage.init();

                const imageBlob = await createTestImageBlob();

                // 儲存 10 筆資料
                for (let i = 1; i <= 10; i++) {
                    const testResult = {
                        originalImageBlob: imageBlob,
                        processedImageBlob: imageBlob,
                        answers: { 1: 'A', 2: 'B', 3: 'C', 4: 'D' },
                        score: 70 + i,
                        templateName: 'default',
                        metadata: { testNumber: i }
                    };

                    await storage.saveResult(testResult);
                    log(testId, `✓ 儲存第 ${i} 筆資料`, 'success');
                }

                // 讀取所有資料
                const allResults = await storage.getAllResults();
                log(testId, `✓ 讀取到 ${allResults.length} 筆資料`, 'success');

                // 顯示結果表格
                const resultsDiv = document.getElementById(`${testId}-results`);
                let html = '<table class="results-table"><tr><th>ID</th><th>時間</th><th>分數</th><th>模板</th></tr>';
                allResults.forEach(result => {
                    html += `<tr>
                        <td>${result.id}</td>
                        <td>${new Date(result.timestamp).toLocaleString()}</td>
                        <td>${result.score}</td>
                        <td>${result.templateName}</td>
                    </tr>`;
                });
                html += '</table>';
                resultsDiv.innerHTML = html;

                setStatus(testId, 'success', '✓ 測試通過');
            } catch (error) {
                log(testId, `✗ 錯誤: ${error.message}`, 'error');
                setStatus(testId, 'error', '✗ 測試失敗');
            }
        }

        // 測試 4: 影像 Blob 儲存與還原
        async function runTest4() {
            const testId = 'test4';
            const fileInput = document.getElementById('test4-file');

            if (!fileInput.files[0]) {
                alert('請先選擇一張圖片');
                return;
            }

            setStatus(testId, 'running', '測試進行中...');
            log(testId, '開始測試影像 Blob 儲存與還原', 'info');

            try {
                const storage = new OMRStorage();
                await storage.init();

                const file = fileInput.files[0];
                const imageBlob = new Blob([await file.arrayBuffer()], { type: file.type });

                log(testId, `圖片大小: ${(imageBlob.size / 1024).toFixed(2)} KB`, 'info');

                const testResult = {
                    originalImageBlob: imageBlob,
                    processedImageBlob: imageBlob,
                    answers: { 1: 'A' },
                    score: 100,
                    templateName: 'test',
                    metadata: { fileName: file.name }
                };

                const id = await storage.saveResult(testResult);
                log(testId, `✓ 儲存成功，ID: ${id}`, 'success');

                // 讀取並顯示圖片
                const saved = await storage.getResultById(id);
                const url = URL.createObjectURL(saved.originalImageBlob);

                const resultsDiv = document.getElementById(`${testId}-results`);
                resultsDiv.innerHTML = `
                    <h3>原始圖片:</h3>
                    <img src="${url}" class="thumbnail" onload="URL.revokeObjectURL(this.src)">
                    <p>檔案名稱: ${saved.metadata.fileName}</p>
                `;

                log(testId, '✓ 圖片還原成功', 'success');
                setStatus(testId, 'success', '✓ 測試通過');
            } catch (error) {
                log(testId, `✗ 錯誤: ${error.message}`, 'error');
                setStatus(testId, 'error', '✗ 測試失敗');
            }
        }

        // 測試 5: 刪除單筆記錄
        async function runTest5() {
            const testId = 'test5';
            setStatus(testId, 'running', '測試進行中...');
            log(testId, '開始測試刪除單筆記錄', 'info');

            try {
                const storage = new OMRStorage();
                await storage.init();

                // 先建立一筆資料
                const imageBlob = await createTestImageBlob();
                const testResult = {
                    originalImageBlob: imageBlob,
                    processedImageBlob: imageBlob,
                    answers: { 1: 'A' },
                    score: 90,
                    templateName: 'test',
                    metadata: {}
                };

                const id = await storage.saveResult(testResult);
                log(testId, `✓ 建立測試資料，ID: ${id}`, 'success');

                // 刪除資料
                await storage.deleteResult(id);
                log(testId, `✓ 刪除成功`, 'success');

                // 驗證已刪除
                const deleted = await storage.getResultById(id);
                if (deleted === undefined) {
                    log(testId, '✓ 確認資料已刪除', 'success');
                    setStatus(testId, 'success', '✓ 測試通過');
                } else {
                    throw new Error('資料未正確刪除');
                }
            } catch (error) {
                log(testId, `✗ 錯誤: ${error.message}`, 'error');
                setStatus(testId, 'error', '✗ 測試失敗');
            }
        }

        // 測試 6: 刪除所有記錄
        async function runTest6() {
            const testId = 'test6';
            setStatus(testId, 'running', '測試進行中...');
            log(testId, '開始測試刪除所有記錄', 'info');

            try {
                const storage = new OMRStorage();
                await storage.init();

                // 先建立幾筆資料
                const imageBlob = await createTestImageBlob();
                for (let i = 0; i < 3; i++) {
                    await storage.saveResult({
                        originalImageBlob: imageBlob,
                        processedImageBlob: imageBlob,
                        answers: {},
                        score: i * 10,
                        templateName: 'test',
                        metadata: {}
                    });
                }
                log(testId, '✓ 建立 3 筆測試資料', 'success');

                // 刪除所有資料
                await storage.deleteAllResults();
                log(testId, '✓ 刪除所有資料', 'success');

                // 驗證
                const allResults = await storage.getAllResults();
                if (allResults.length === 0) {
                    log(testId, '✓ 確認所有資料已清空', 'success');
                    setStatus(testId, 'success', '✓ 測試通過');
                } else {
                    throw new Error(`仍有 ${allResults.length} 筆資料未刪除`);
                }
            } catch (error) {
                log(testId, `✗ 錯誤: ${error.message}`, 'error');
                setStatus(testId, 'error', '✗ 測試失敗');
            }
        }

        // 測試 7: 模板儲存與讀取
        async function runTest7() {
            const testId = 'test7';
            setStatus(testId, 'running', '測試進行中...');
            log(testId, '開始測試模板儲存與讀取', 'info');

            try {
                const storage = new OMRStorage();
                await storage.init();

                const testTemplate = {
                    name: 'custom-test',
                    config: {
                        questions: 20,
                        options: ['A', 'B', 'C', 'D'],
                        layout: 'vertical'
                    },
                    createdAt: new Date()
                };

                await storage.saveTemplate(testTemplate);
                log(testId, `✓ 儲存模板: ${testTemplate.name}`, 'success');

                const saved = await storage.getTemplate(testTemplate.name);
                log(testId, `✓ 讀取模板成功`, 'success');
                log(testId, `問題數: ${saved.config.questions}`, 'info');
                log(testId, `選項: ${saved.config.options.join(', ')}`, 'info');

                setStatus(testId, 'success', '✓ 測試通過');
            } catch (error) {
                log(testId, `✗ 錯誤: ${error.message}`, 'error');
                setStatus(testId, 'error', '✗ 測試失敗');
            }
        }

        // 測試 8: 資料持久化驗證
        async function runTest8() {
            const testId = 'test8';
            setStatus(testId, 'running', '驗證中...');
            log(testId, '開始驗證資料持久化', 'info');

            try {
                const storage = new OMRStorage();
                await storage.init();

                const allResults = await storage.getAllResults();

                if (allResults.length > 0) {
                    log(testId, `✓ 找到 ${allResults.length} 筆持久化資料`, 'success');

                    allResults.forEach((result, index) => {
                        log(testId, `記錄 ${index + 1}: 分數=${result.score}, 時間=${new Date(result.timestamp).toLocaleString()}`, 'info');
                    });

                    setStatus(testId, 'success', '✓ 資料持久化測試通過');
                } else {
                    log(testId, '⚠ 未找到持久化資料', 'warn');
                    log(testId, '請先執行測試 3 並重新載入頁面', 'warn');
                    setStatus(testId, 'pending', '等待測試');
                }
            } catch (error) {
                log(testId, `✗ 錯誤: ${error.message}`, 'error');
                setStatus(testId, 'error', '✗ 測試失敗');
            }
        }

        // 執行所有測試
        async function runAllTests() {
            console.log('🚀 開始執行所有測試');

            await runTest1();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runTest2();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runTest3();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runTest5();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runTest6();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runTest7();

            console.log('✅ 所有測試執行完成');
            alert('所有測試執行完成！請檢查結果。');
        }

        // 清空所有資料
        async function clearAllData() {
            if (!confirm('確定要清空所有儲存的資料嗎？此操作無法復原。')) {
                return;
            }

            try {
                const storage = new OMRStorage();
                await storage.init();
                await storage.deleteAllResults();
                alert('✓ 所有資料已清空');
                window.location.reload();
            } catch (error) {
                alert('✗ 清空失敗: ' + error.message);
            }
        }
    </script>
</body>
</html>
