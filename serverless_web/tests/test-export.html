<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Module Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 2rem;
            background: #f8fafc;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2563eb;
            margin-bottom: 1rem;
        }

        h2 {
            color: #1e293b;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f1f5f9;
            border-radius: 6px;
        }

        .test-section h3 {
            color: #475569;
            margin-bottom: 0.75rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: background 0.3s;
        }

        button:hover {
            background: #1d4ed8;
        }

        button.secondary {
            background: #64748b;
        }

        button.secondary:hover {
            background: #475569;
        }

        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #10b981;
        }

        .test-result.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .test-result pre {
            background: #1e293b;
            color: #f1f5f9;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .info {
            background: #dbeafe;
            border-left: 4px solid #2563eb;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .success {
            color: #10b981;
            font-weight: 600;
        }

        .error {
            color: #ef4444;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Export Module Test Suite</h1>
        <p>測試 OMR Checker 的結果匯出功能</p>

        <div class="info">
            <strong>注意:</strong> 執行測試將會自動下載檔案。請檢查下載的檔案內容是否正確。
        </div>

        <h2>1. CSV 匯出測試</h2>

        <div class="test-section">
            <h3>Test 1.1: 單筆結果匯出 CSV</h3>
            <button onclick="testSingleCSVExport()">執行測試</button>
            <div id="test-1-1-result"></div>
        </div>

        <div class="test-section">
            <h3>Test 1.2: 批次結果匯出 CSV</h3>
            <button onclick="testBatchCSVExport()">執行測試</button>
            <div id="test-1-2-result"></div>
        </div>

        <h2>2. JSON 匯出測試</h2>

        <div class="test-section">
            <h3>Test 2.1: 單筆結果匯出 JSON</h3>
            <button onclick="testSingleJSONExport()">執行測試</button>
            <div id="test-2-1-result"></div>
        </div>

        <div class="test-section">
            <h3>Test 2.2: 批次結果匯出 JSON</h3>
            <button onclick="testBatchJSONExport()">執行測試</button>
            <div id="test-2-2-result"></div>
        </div>

        <h2>3. 檔案名稱生成測試</h2>

        <div class="test-section">
            <h3>Test 3.1: 安全檔案名稱生成</h3>
            <button onclick="testSafeFileName()">執行測試</button>
            <div id="test-3-1-result"></div>
        </div>

        <h2>4. 錯誤處理測試</h2>

        <div class="test-section">
            <h3>Test 4.1: 無效資料處理</h3>
            <button onclick="testInvalidData()">執行測試</button>
            <div id="test-4-1-result"></div>
        </div>

        <h2>5. 全部測試</h2>

        <div class="test-section">
            <button onclick="runAllTests()">🚀 執行所有測試</button>
            <button class="secondary" onclick="clearResults()">🗑️ 清除結果</button>
        </div>
    </div>

    <!-- 載入 export.js -->
    <script src="../assets/js/export.js"></script>

    <script>
        // 測試資料生成器
        function generateMockResult() {
            return {
                omr: {
                    answers: {
                        '1': ['A'],
                        '2': ['B'],
                        '3': ['C'],
                        '4': ['D'],
                        '5': ['A']
                    },
                    scoring: {
                        score: 80,
                        totalPoints: 100,
                        percentage: 80,
                        totalQuestions: 5,
                        correctCount: 4,
                        incorrectCount: 1,
                        unansweredCount: 0,
                        details: {
                            '1': { student: 'A', correct: 'A', isCorrect: true, status: 'correct' },
                            '2': { student: 'B', correct: 'C', isCorrect: false, status: 'incorrect' },
                            '3': { student: 'C', correct: 'C', isCorrect: true, status: 'correct' },
                            '4': { student: 'D', correct: 'D', isCorrect: true, status: 'correct' },
                            '5': { student: 'A', correct: 'A', isCorrect: true, status: 'correct' }
                        }
                    }
                }
            };
        }

        function generateMockTemplate() {
            return {
                name: '標準測驗模板',
                totalQuestions: 5
            };
        }

        function generateMockBatchResults() {
            return [
                {
                    id: 1,
                    timestamp: new Date('2025-10-05T10:00:00'),
                    templateName: '標準測驗模板',
                    answers: { '1': ['A'], '2': ['B'] },
                    score: 85,
                    metadata: { fileName: 'test1.jpg' }
                },
                {
                    id: 2,
                    timestamp: new Date('2025-10-05T11:00:00'),
                    templateName: '標準測驗模板',
                    answers: { '1': ['C'], '2': ['D'] },
                    score: 90,
                    metadata: { fileName: 'test2.jpg' }
                }
            ];
        }

        // 測試函數
        function testSingleCSVExport() {
            const resultDiv = document.getElementById('test-1-1-result');
            try {
                const result = generateMockResult();
                const template = generateMockTemplate();

                OMRExporter.exportToCSV(result, template, 'test-single-result.csv');

                resultDiv.innerHTML = '<div class="test-result"><span class="success">✓ 測試通過</span><p>請檢查下載的 CSV 檔案內容</p></div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error"><span class="error">✗ 測試失敗</span><p>${error.message}</p></div>`;
            }
        }

        function testBatchCSVExport() {
            const resultDiv = document.getElementById('test-1-2-result');
            try {
                const results = generateMockBatchResults();

                OMRExporter.exportBatchToCSV(results, 'test-batch-results.csv');

                resultDiv.innerHTML = '<div class="test-result"><span class="success">✓ 測試通過</span><p>請檢查下載的 CSV 檔案內容</p></div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error"><span class="error">✗ 測試失敗</span><p>${error.message}</p></div>`;
            }
        }

        function testSingleJSONExport() {
            const resultDiv = document.getElementById('test-2-1-result');
            try {
                const result = generateMockResult();
                const template = generateMockTemplate();
                const metadata = { fileName: 'test.jpg', fileSize: 1024000 };

                OMRExporter.exportToJSON(result, template, metadata, 'test-single-result.json');

                resultDiv.innerHTML = '<div class="test-result"><span class="success">✓ 測試通過</span><p>請檢查下載的 JSON 檔案內容</p></div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error"><span class="error">✗ 測試失敗</span><p>${error.message}</p></div>`;
            }
        }

        function testBatchJSONExport() {
            const resultDiv = document.getElementById('test-2-2-result');
            try {
                const results = generateMockBatchResults();

                OMRExporter.exportBatchToJSON(results, 'test-batch-results.json');

                resultDiv.innerHTML = '<div class="test-result"><span class="success">✓ 測試通過</span><p>請檢查下載的 JSON 檔案內容</p></div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error"><span class="error">✗ 測試失敗</span><p>${error.message}</p></div>`;
            }
        }

        function testSafeFileName() {
            const resultDiv = document.getElementById('test-3-1-result');
            try {
                const testCases = [
                    { input: '測試檔案', expected: /^測試檔案_\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}\.csv$/ },
                    { input: 'test@#$%file', expected: /^test____file_\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}\.json$/ },
                    { input: '中文English123', expected: /^中文English123_\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}\.txt$/ }
                ];

                let allPassed = true;
                let results = '<div class="test-result"><pre>';

                testCases.forEach((testCase, index) => {
                    const ext = index === 0 ? 'csv' : index === 1 ? 'json' : 'txt';
                    const fileName = OMRExporter.generateSafeFileName(testCase.input, ext);
                    const passed = testCase.expected.test(fileName);

                    results += `Test ${index + 1}: ${testCase.input}\n`;
                    results += `  生成檔名: ${fileName}\n`;
                    results += `  結果: ${passed ? '✓ 通過' : '✗ 失敗'}\n\n`;

                    if (!passed) allPassed = false;
                });

                results += '</pre>';
                results += allPassed ? '<span class="success">✓ 所有測試通過</span>' : '<span class="error">✗ 部分測試失敗</span>';
                results += '</div>';

                resultDiv.innerHTML = results;
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error"><span class="error">✗ 測試失敗</span><p>${error.message}</p></div>`;
            }
        }

        function testInvalidData() {
            const resultDiv = document.getElementById('test-4-1-result');
            let results = '<div class="test-result"><pre>';
            let allPassed = true;

            // Test 1: null result
            try {
                OMRExporter.exportToCSV(null, null, 'test.csv');
                results += 'Test 1 (null result): ✗ 應拋出錯誤但未拋出\n';
                allPassed = false;
            } catch (error) {
                results += 'Test 1 (null result): ✓ 正確拋出錯誤\n';
            }

            // Test 2: result without omr
            try {
                OMRExporter.exportToCSV({}, null, 'test.csv');
                results += 'Test 2 (no omr): ✗ 應拋出錯誤但未拋出\n';
                allPassed = false;
            } catch (error) {
                results += 'Test 2 (no omr): ✓ 正確拋出錯誤\n';
            }

            // Test 3: empty array for batch
            try {
                OMRExporter.exportBatchToCSV([], 'test.csv');
                results += 'Test 3 (empty array): ✗ 應拋出錯誤但未拋出\n';
                allPassed = false;
            } catch (error) {
                results += 'Test 3 (empty array): ✓ 正確拋出錯誤\n';
            }

            // Test 4: non-array for batch
            try {
                OMRExporter.exportBatchToJSON('not an array', 'test.json');
                results += 'Test 4 (non-array): ✗ 應拋出錯誤但未拋出\n';
                allPassed = false;
            } catch (error) {
                results += 'Test 4 (non-array): ✓ 正確拋出錯誤\n';
            }

            results += '</pre>';
            results += allPassed ? '<span class="success">✓ 所有測試通過</span>' : '<span class="error">✗ 部分測試失敗</span>';
            results += '</div>';

            resultDiv.innerHTML = results;
        }

        function runAllTests() {
            console.log('🚀 開始執行所有測試...');

            // 注意：這裡不自動觸發下載測試，避免一次下載太多檔案
            // 只執行不需要下載的測試
            testSafeFileName();
            testInvalidData();

            alert('部分測試已完成！請手動執行下載測試以檢查匯出功能。');
        }

        function clearResults() {
            const resultDivs = document.querySelectorAll('[id$="-result"]');
            resultDivs.forEach(div => div.innerHTML = '');
        }

        // 頁面載入時顯示資訊
        window.addEventListener('load', () => {
            console.log('✅ Export Module 測試頁面已載入');
            console.log('📦 OMRExporter 類別:', typeof OMRExporter);
        });
    </script>
</body>
</html>
