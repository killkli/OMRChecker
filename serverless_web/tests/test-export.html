<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Module Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 2rem;
            background: #f8fafc;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2563eb;
            margin-bottom: 1rem;
        }

        h2 {
            color: #1e293b;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f1f5f9;
            border-radius: 6px;
        }

        .test-section h3 {
            color: #475569;
            margin-bottom: 0.75rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: background 0.3s;
        }

        button:hover {
            background: #1d4ed8;
        }

        button.secondary {
            background: #64748b;
        }

        button.secondary:hover {
            background: #475569;
        }

        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #10b981;
        }

        .test-result.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .test-result pre {
            background: #1e293b;
            color: #f1f5f9;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .info {
            background: #dbeafe;
            border-left: 4px solid #2563eb;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .success {
            color: #10b981;
            font-weight: 600;
        }

        .error {
            color: #ef4444;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Export Module Test Suite</h1>
        <p>æ¸¬è©¦ OMR Checker çš„çµæœåŒ¯å‡ºåŠŸèƒ½</p>

        <div class="info">
            <strong>æ³¨æ„:</strong> åŸ·è¡Œæ¸¬è©¦å°‡æœƒè‡ªå‹•ä¸‹è¼‰æª”æ¡ˆã€‚è«‹æª¢æŸ¥ä¸‹è¼‰çš„æª”æ¡ˆå…§å®¹æ˜¯å¦æ­£ç¢ºã€‚
        </div>

        <h2>1. CSV åŒ¯å‡ºæ¸¬è©¦</h2>

        <div class="test-section">
            <h3>Test 1.1: å–®ç­†çµæœåŒ¯å‡º CSV</h3>
            <button onclick="testSingleCSVExport()">åŸ·è¡Œæ¸¬è©¦</button>
            <div id="test-1-1-result"></div>
        </div>

        <div class="test-section">
            <h3>Test 1.2: æ‰¹æ¬¡çµæœåŒ¯å‡º CSV</h3>
            <button onclick="testBatchCSVExport()">åŸ·è¡Œæ¸¬è©¦</button>
            <div id="test-1-2-result"></div>
        </div>

        <h2>2. JSON åŒ¯å‡ºæ¸¬è©¦</h2>

        <div class="test-section">
            <h3>Test 2.1: å–®ç­†çµæœåŒ¯å‡º JSON</h3>
            <button onclick="testSingleJSONExport()">åŸ·è¡Œæ¸¬è©¦</button>
            <div id="test-2-1-result"></div>
        </div>

        <div class="test-section">
            <h3>Test 2.2: æ‰¹æ¬¡çµæœåŒ¯å‡º JSON</h3>
            <button onclick="testBatchJSONExport()">åŸ·è¡Œæ¸¬è©¦</button>
            <div id="test-2-2-result"></div>
        </div>

        <h2>3. æª”æ¡ˆåç¨±ç”Ÿæˆæ¸¬è©¦</h2>

        <div class="test-section">
            <h3>Test 3.1: å®‰å…¨æª”æ¡ˆåç¨±ç”Ÿæˆ</h3>
            <button onclick="testSafeFileName()">åŸ·è¡Œæ¸¬è©¦</button>
            <div id="test-3-1-result"></div>
        </div>

        <h2>4. éŒ¯èª¤è™•ç†æ¸¬è©¦</h2>

        <div class="test-section">
            <h3>Test 4.1: ç„¡æ•ˆè³‡æ–™è™•ç†</h3>
            <button onclick="testInvalidData()">åŸ·è¡Œæ¸¬è©¦</button>
            <div id="test-4-1-result"></div>
        </div>

        <h2>5. å…¨éƒ¨æ¸¬è©¦</h2>

        <div class="test-section">
            <button onclick="runAllTests()">ğŸš€ åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
            <button class="secondary" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
        </div>
    </div>

    <!-- è¼‰å…¥ export.js -->
    <script src="../assets/js/export.js"></script>

    <script>
        // æ¸¬è©¦è³‡æ–™ç”Ÿæˆå™¨
        function generateMockResult() {
            return {
                omr: {
                    answers: {
                        '1': ['A'],
                        '2': ['B'],
                        '3': ['C'],
                        '4': ['D'],
                        '5': ['A']
                    },
                    scoring: {
                        score: 80,
                        totalPoints: 100,
                        percentage: 80,
                        totalQuestions: 5,
                        correctCount: 4,
                        incorrectCount: 1,
                        unansweredCount: 0,
                        details: {
                            '1': { student: 'A', correct: 'A', isCorrect: true, status: 'correct' },
                            '2': { student: 'B', correct: 'C', isCorrect: false, status: 'incorrect' },
                            '3': { student: 'C', correct: 'C', isCorrect: true, status: 'correct' },
                            '4': { student: 'D', correct: 'D', isCorrect: true, status: 'correct' },
                            '5': { student: 'A', correct: 'A', isCorrect: true, status: 'correct' }
                        }
                    }
                }
            };
        }

        function generateMockTemplate() {
            return {
                name: 'æ¨™æº–æ¸¬é©—æ¨¡æ¿',
                totalQuestions: 5
            };
        }

        function generateMockBatchResults() {
            return [
                {
                    id: 1,
                    timestamp: new Date('2025-10-05T10:00:00'),
                    templateName: 'æ¨™æº–æ¸¬é©—æ¨¡æ¿',
                    answers: { '1': ['A'], '2': ['B'] },
                    score: 85,
                    metadata: { fileName: 'test1.jpg' }
                },
                {
                    id: 2,
                    timestamp: new Date('2025-10-05T11:00:00'),
                    templateName: 'æ¨™æº–æ¸¬é©—æ¨¡æ¿',
                    answers: { '1': ['C'], '2': ['D'] },
                    score: 90,
                    metadata: { fileName: 'test2.jpg' }
                }
            ];
        }

        // æ¸¬è©¦å‡½æ•¸
        function testSingleCSVExport() {
            const resultDiv = document.getElementById('test-1-1-result');
            try {
                const result = generateMockResult();
                const template = generateMockTemplate();

                OMRExporter.exportToCSV(result, template, 'test-single-result.csv');

                resultDiv.innerHTML = '<div class="test-result"><span class="success">âœ“ æ¸¬è©¦é€šé</span><p>è«‹æª¢æŸ¥ä¸‹è¼‰çš„ CSV æª”æ¡ˆå…§å®¹</p></div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error"><span class="error">âœ— æ¸¬è©¦å¤±æ•—</span><p>${error.message}</p></div>`;
            }
        }

        function testBatchCSVExport() {
            const resultDiv = document.getElementById('test-1-2-result');
            try {
                const results = generateMockBatchResults();

                OMRExporter.exportBatchToCSV(results, 'test-batch-results.csv');

                resultDiv.innerHTML = '<div class="test-result"><span class="success">âœ“ æ¸¬è©¦é€šé</span><p>è«‹æª¢æŸ¥ä¸‹è¼‰çš„ CSV æª”æ¡ˆå…§å®¹</p></div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error"><span class="error">âœ— æ¸¬è©¦å¤±æ•—</span><p>${error.message}</p></div>`;
            }
        }

        function testSingleJSONExport() {
            const resultDiv = document.getElementById('test-2-1-result');
            try {
                const result = generateMockResult();
                const template = generateMockTemplate();
                const metadata = { fileName: 'test.jpg', fileSize: 1024000 };

                OMRExporter.exportToJSON(result, template, metadata, 'test-single-result.json');

                resultDiv.innerHTML = '<div class="test-result"><span class="success">âœ“ æ¸¬è©¦é€šé</span><p>è«‹æª¢æŸ¥ä¸‹è¼‰çš„ JSON æª”æ¡ˆå…§å®¹</p></div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error"><span class="error">âœ— æ¸¬è©¦å¤±æ•—</span><p>${error.message}</p></div>`;
            }
        }

        function testBatchJSONExport() {
            const resultDiv = document.getElementById('test-2-2-result');
            try {
                const results = generateMockBatchResults();

                OMRExporter.exportBatchToJSON(results, 'test-batch-results.json');

                resultDiv.innerHTML = '<div class="test-result"><span class="success">âœ“ æ¸¬è©¦é€šé</span><p>è«‹æª¢æŸ¥ä¸‹è¼‰çš„ JSON æª”æ¡ˆå…§å®¹</p></div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error"><span class="error">âœ— æ¸¬è©¦å¤±æ•—</span><p>${error.message}</p></div>`;
            }
        }

        function testSafeFileName() {
            const resultDiv = document.getElementById('test-3-1-result');
            try {
                const testCases = [
                    { input: 'æ¸¬è©¦æª”æ¡ˆ', expected: /^æ¸¬è©¦æª”æ¡ˆ_\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}\.csv$/ },
                    { input: 'test@#$%file', expected: /^test____file_\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}\.json$/ },
                    { input: 'ä¸­æ–‡English123', expected: /^ä¸­æ–‡English123_\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}\.txt$/ }
                ];

                let allPassed = true;
                let results = '<div class="test-result"><pre>';

                testCases.forEach((testCase, index) => {
                    const ext = index === 0 ? 'csv' : index === 1 ? 'json' : 'txt';
                    const fileName = OMRExporter.generateSafeFileName(testCase.input, ext);
                    const passed = testCase.expected.test(fileName);

                    results += `Test ${index + 1}: ${testCase.input}\n`;
                    results += `  ç”Ÿæˆæª”å: ${fileName}\n`;
                    results += `  çµæœ: ${passed ? 'âœ“ é€šé' : 'âœ— å¤±æ•—'}\n\n`;

                    if (!passed) allPassed = false;
                });

                results += '</pre>';
                results += allPassed ? '<span class="success">âœ“ æ‰€æœ‰æ¸¬è©¦é€šé</span>' : '<span class="error">âœ— éƒ¨åˆ†æ¸¬è©¦å¤±æ•—</span>';
                results += '</div>';

                resultDiv.innerHTML = results;
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error"><span class="error">âœ— æ¸¬è©¦å¤±æ•—</span><p>${error.message}</p></div>`;
            }
        }

        function testInvalidData() {
            const resultDiv = document.getElementById('test-4-1-result');
            let results = '<div class="test-result"><pre>';
            let allPassed = true;

            // Test 1: null result
            try {
                OMRExporter.exportToCSV(null, null, 'test.csv');
                results += 'Test 1 (null result): âœ— æ‡‰æ‹‹å‡ºéŒ¯èª¤ä½†æœªæ‹‹å‡º\n';
                allPassed = false;
            } catch (error) {
                results += 'Test 1 (null result): âœ“ æ­£ç¢ºæ‹‹å‡ºéŒ¯èª¤\n';
            }

            // Test 2: result without omr
            try {
                OMRExporter.exportToCSV({}, null, 'test.csv');
                results += 'Test 2 (no omr): âœ— æ‡‰æ‹‹å‡ºéŒ¯èª¤ä½†æœªæ‹‹å‡º\n';
                allPassed = false;
            } catch (error) {
                results += 'Test 2 (no omr): âœ“ æ­£ç¢ºæ‹‹å‡ºéŒ¯èª¤\n';
            }

            // Test 3: empty array for batch
            try {
                OMRExporter.exportBatchToCSV([], 'test.csv');
                results += 'Test 3 (empty array): âœ— æ‡‰æ‹‹å‡ºéŒ¯èª¤ä½†æœªæ‹‹å‡º\n';
                allPassed = false;
            } catch (error) {
                results += 'Test 3 (empty array): âœ“ æ­£ç¢ºæ‹‹å‡ºéŒ¯èª¤\n';
            }

            // Test 4: non-array for batch
            try {
                OMRExporter.exportBatchToJSON('not an array', 'test.json');
                results += 'Test 4 (non-array): âœ— æ‡‰æ‹‹å‡ºéŒ¯èª¤ä½†æœªæ‹‹å‡º\n';
                allPassed = false;
            } catch (error) {
                results += 'Test 4 (non-array): âœ“ æ­£ç¢ºæ‹‹å‡ºéŒ¯èª¤\n';
            }

            results += '</pre>';
            results += allPassed ? '<span class="success">âœ“ æ‰€æœ‰æ¸¬è©¦é€šé</span>' : '<span class="error">âœ— éƒ¨åˆ†æ¸¬è©¦å¤±æ•—</span>';
            results += '</div>';

            resultDiv.innerHTML = results;
        }

        function runAllTests() {
            console.log('ğŸš€ é–‹å§‹åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦...');

            // æ³¨æ„ï¼šé€™è£¡ä¸è‡ªå‹•è§¸ç™¼ä¸‹è¼‰æ¸¬è©¦ï¼Œé¿å…ä¸€æ¬¡ä¸‹è¼‰å¤ªå¤šæª”æ¡ˆ
            // åªåŸ·è¡Œä¸éœ€è¦ä¸‹è¼‰çš„æ¸¬è©¦
            testSafeFileName();
            testInvalidData();

            alert('éƒ¨åˆ†æ¸¬è©¦å·²å®Œæˆï¼è«‹æ‰‹å‹•åŸ·è¡Œä¸‹è¼‰æ¸¬è©¦ä»¥æª¢æŸ¥åŒ¯å‡ºåŠŸèƒ½ã€‚');
        }

        function clearResults() {
            const resultDivs = document.querySelectorAll('[id$="-result"]');
            resultDivs.forEach(div => div.innerHTML = '');
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºè³‡è¨Š
        window.addEventListener('load', () => {
            console.log('âœ… Export Module æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('ğŸ“¦ OMRExporter é¡åˆ¥:', typeof OMRExporter);
        });
    </script>
</body>
</html>
