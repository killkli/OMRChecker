<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Critical Fixes é©—è­‰æ¸¬è©¦ - OMR Checker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }

        .test-section {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #f44336;
            padding-bottom: 0.5rem;
        }

        h2 {
            color: #666;
            margin-top: 0;
        }

        .status {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            font-weight: bold;
        }

        .status.pending {
            background: #FFF3CD;
            color: #856404;
        }

        .status.running {
            background: #D1ECF1;
            color: #0C5460;
        }

        .status.success {
            background: #D4EDDA;
            color: #155724;
        }

        .status.error {
            background: #F8D7DA;
            color: #721C24;
        }

        button {
            padding: 0.75rem 1.5rem;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }

        button:hover {
            background: #d32f2f;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin: 0.25rem 0;
            padding: 0.25rem;
        }

        .log-entry.info { color: #0C5460; }
        .log-entry.success { color: #155724; }
        .log-entry.error { color: #721C24; }
        .log-entry.warn { color: #856404; }

        code {
            background: #f4f4f4;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>ğŸ”´ Critical Fixes é©—è­‰æ¸¬è©¦</h1>
    <p>æ­¤æ¸¬è©¦ç”¨æ–¼é©—è­‰ Stage 6 çš„ 3 å€‹é—œéµå•é¡Œä¿®å¾©ï¼š</p>
    <ol>
        <li><strong>Blob URL Memory Leak</strong>: é©—è­‰ Blob URLs æ­£ç¢ºé‡‹æ”¾</li>
        <li><strong>Data Validation</strong>: é©—è­‰ answers å’Œ metadata é¡å‹æª¢æŸ¥</li>
        <li><strong>Global Variable Pollution</strong>: é©—è­‰ç„¡å…¨åŸŸè®Šæ•¸æ±¡æŸ“</li>
    </ol>

    <!-- æ¸¬è©¦ 1: Data Validation -->
    <div class="test-section">
        <h2>æ¸¬è©¦ 1: Data Validation - é©—è­‰è³‡æ–™å‹åˆ¥æª¢æŸ¥</h2>
        <p>æ¸¬è©¦ <code>answers</code> å’Œ <code>metadata</code> å¿…é ˆæ˜¯ç‰©ä»¶é¡å‹</p>
        <div id="test1-status" class="status pending">ç­‰å¾…æ¸¬è©¦</div>
        <button onclick="runTest1()">åŸ·è¡Œæ¸¬è©¦</button>
        <div id="test1-log" class="log"></div>
    </div>

    <!-- æ¸¬è©¦ 2: Blob URL Tracking -->
    <div class="test-section">
        <h2>æ¸¬è©¦ 2: Blob URL Tracking - é©—è­‰ activeBlobUrls å­˜åœ¨</h2>
        <p>æ¸¬è©¦ OMRApp é¡åˆ¥ä¸­æ˜¯å¦æœ‰ <code>activeBlobUrls</code> å’Œ <code>revokeAllBlobUrls()</code></p>
        <div id="test2-status" class="status pending">ç­‰å¾…æ¸¬è©¦</div>
        <button onclick="runTest2()">åŸ·è¡Œæ¸¬è©¦</button>
        <div id="test2-log" class="log"></div>
    </div>

    <!-- æ¸¬è©¦ 3: Global Variable Check -->
    <div class="test-section">
        <h2>æ¸¬è©¦ 3: Global Variable Check - é©—è­‰ç„¡å…¨åŸŸæ±¡æŸ“</h2>
        <p>æª¢æŸ¥å…¨åŸŸå‘½åç©ºé–“æ˜¯å¦æœ‰ <code>app</code> è®Šæ•¸</p>
        <div id="test3-status" class="status pending">ç­‰å¾…æ¸¬è©¦</div>
        <button onclick="runTest3()">åŸ·è¡Œæ¸¬è©¦</button>
        <div id="test3-log" class="log"></div>
    </div>

    <!-- åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ -->
    <div class="test-section">
        <h2>ğŸš€ åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</h2>
        <button onclick="runAllTests()" style="background: #2196F3;">åŸ·è¡Œå…¨éƒ¨æ¸¬è©¦</button>
    </div>

    <script src="../assets/js/storage.js"></script>
    <script>
        // æ¸¬è©¦å·¥å…·å‡½æ•¸
        function log(testId, message, type = 'info') {
            const logDiv = document.getElementById(`${testId}-log`);
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setStatus(testId, status, message) {
            const statusDiv = document.getElementById(`${testId}-status`);
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = message;
        }

        // å»ºç«‹æ¸¬è©¦ç”¨å½±åƒ Blob
        function createTestImageBlob() {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(0, 0, 100, 100);
                canvas.toBlob(resolve, 'image/png');
            });
        }

        // æ¸¬è©¦ 1: Data Validation
        async function runTest1() {
            const testId = 'test1';
            setStatus(testId, 'running', 'æ¸¬è©¦é€²è¡Œä¸­...');
            log(testId, 'é–‹å§‹æ¸¬è©¦è³‡æ–™å‹åˆ¥é©—è­‰', 'info');

            try {
                const storage = new OMRStorage();
                await storage.init();

                const imageBlob = await createTestImageBlob();
                let testsPassed = 0;
                let totalTests = 4;

                // æ¸¬è©¦ 1.1: answers ç‚º string (æ‡‰è©²å¤±æ•—)
                log(testId, 'æ¸¬è©¦ 1.1: answers ç‚º string', 'info');
                try {
                    await storage.saveResult({
                        originalImageBlob: imageBlob,
                        processedImageBlob: imageBlob,
                        answers: "invalid string",  // âŒ æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤
                        score: 80,
                        templateName: 'test',
                        metadata: {}
                    });
                    log(testId, 'âœ— æ¸¬è©¦ 1.1 å¤±æ•—: æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤ä½†æ²’æœ‰', 'error');
                } catch (error) {
                    if (error.message.includes('answers å¿…é ˆæ˜¯ç‰©ä»¶é¡å‹')) {
                        log(testId, 'âœ“ æ¸¬è©¦ 1.1 é€šé: æ­£ç¢ºæ•æ‰åˆ°éŒ¯èª¤', 'success');
                        testsPassed++;
                    } else {
                        log(testId, `âœ— æ¸¬è©¦ 1.1 å¤±æ•—: éŒ¯èª¤è¨Šæ¯ä¸æ­£ç¢º - ${error.message}`, 'error');
                    }
                }

                // æ¸¬è©¦ 1.2: answers ç‚º array (æ‡‰è©²å¤±æ•—)
                log(testId, 'æ¸¬è©¦ 1.2: answers ç‚º array', 'info');
                try {
                    await storage.saveResult({
                        originalImageBlob: imageBlob,
                        processedImageBlob: imageBlob,
                        answers: ["A", "B", "C"],  // âŒ æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤
                        score: 80,
                        templateName: 'test',
                        metadata: {}
                    });
                    log(testId, 'âœ— æ¸¬è©¦ 1.2 å¤±æ•—: æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤ä½†æ²’æœ‰', 'error');
                } catch (error) {
                    if (error.message.includes('answers å¿…é ˆæ˜¯ç‰©ä»¶é¡å‹')) {
                        log(testId, 'âœ“ æ¸¬è©¦ 1.2 é€šé: æ­£ç¢ºæ•æ‰åˆ°éŒ¯èª¤', 'success');
                        testsPassed++;
                    } else {
                        log(testId, `âœ— æ¸¬è©¦ 1.2 å¤±æ•—: éŒ¯èª¤è¨Šæ¯ä¸æ­£ç¢º - ${error.message}`, 'error');
                    }
                }

                // æ¸¬è©¦ 1.3: metadata ç‚º string (æ‡‰è©²å¤±æ•—)
                log(testId, 'æ¸¬è©¦ 1.3: metadata ç‚º string', 'info');
                try {
                    await storage.saveResult({
                        originalImageBlob: imageBlob,
                        processedImageBlob: imageBlob,
                        answers: {},
                        score: 80,
                        templateName: 'test',
                        metadata: "invalid string"  // âŒ æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤
                    });
                    log(testId, 'âœ— æ¸¬è©¦ 1.3 å¤±æ•—: æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤ä½†æ²’æœ‰', 'error');
                } catch (error) {
                    if (error.message.includes('metadata å¿…é ˆæ˜¯ç‰©ä»¶é¡å‹')) {
                        log(testId, 'âœ“ æ¸¬è©¦ 1.3 é€šé: æ­£ç¢ºæ•æ‰åˆ°éŒ¯èª¤', 'success');
                        testsPassed++;
                    } else {
                        log(testId, `âœ— æ¸¬è©¦ 1.3 å¤±æ•—: éŒ¯èª¤è¨Šæ¯ä¸æ­£ç¢º - ${error.message}`, 'error');
                    }
                }

                // æ¸¬è©¦ 1.4: æ­£ç¢ºçš„ç‰©ä»¶é¡å‹ (æ‡‰è©²æˆåŠŸ)
                log(testId, 'æ¸¬è©¦ 1.4: æ­£ç¢ºçš„ç‰©ä»¶é¡å‹', 'info');
                try {
                    const id = await storage.saveResult({
                        originalImageBlob: imageBlob,
                        processedImageBlob: imageBlob,
                        answers: { 1: 'A', 2: 'B' },  // âœ“ æ­£ç¢º
                        score: 80,
                        templateName: 'test',
                        metadata: { testName: 'Test 1.4' }  // âœ“ æ­£ç¢º
                    });
                    log(testId, `âœ“ æ¸¬è©¦ 1.4 é€šé: æˆåŠŸå„²å­˜ï¼ŒID: ${id}`, 'success');
                    testsPassed++;

                    // æ¸…ç†
                    await storage.deleteResult(id);
                } catch (error) {
                    log(testId, `âœ— æ¸¬è©¦ 1.4 å¤±æ•—: ${error.message}`, 'error');
                }

                // ç¸½çµ
                if (testsPassed === totalTests) {
                    log(testId, `âœ… æ‰€æœ‰å­æ¸¬è©¦é€šé (${testsPassed}/${totalTests})`, 'success');
                    setStatus(testId, 'success', 'âœ“ æ¸¬è©¦é€šé');
                } else {
                    log(testId, `âš  éƒ¨åˆ†æ¸¬è©¦å¤±æ•— (${testsPassed}/${totalTests})`, 'warn');
                    setStatus(testId, 'error', `âœ— éƒ¨åˆ†æ¸¬è©¦å¤±æ•— (${testsPassed}/${totalTests})`);
                }

            } catch (error) {
                log(testId, `âœ— éŒ¯èª¤: ${error.message}`, 'error');
                setStatus(testId, 'error', 'âœ— æ¸¬è©¦å¤±æ•—');
            }
        }

        // æ¸¬è©¦ 2: Blob URL Tracking
        async function runTest2() {
            const testId = 'test2';
            setStatus(testId, 'running', 'æ¸¬è©¦é€²è¡Œä¸­...');
            log(testId, 'é–‹å§‹æ¸¬è©¦ Blob URL è¿½è¹¤æ©Ÿåˆ¶', 'info');

            try {
                // æª¢æŸ¥ app.js æ˜¯å¦å·²è¼‰å…¥ (é€éæª¢æŸ¥å…¨åŸŸæ˜¯å¦æœ‰ç›¸é—œå‡½æ•¸æˆ–é¡åˆ¥)
                log(testId, 'æ³¨æ„: æ­¤æ¸¬è©¦éœ€è¦åœ¨ä¸»æ‡‰ç”¨ç¨‹å¼ä¸­åŸ·è¡Œæ‰èƒ½å®Œæ•´é©—è­‰', 'warn');
                log(testId, 'ç›®å‰åƒ…æª¢æŸ¥ç¨‹å¼ç¢¼çµæ§‹', 'info');

                // é€é fetch è®€å– app.js ç¨‹å¼ç¢¼ä¸¦æª¢æŸ¥
                const response = await fetch('../assets/js/app.js');
                const appJsCode = await response.text();

                let testsPassed = 0;
                let totalTests = 3;

                // æª¢æŸ¥ 1: activeBlobUrls å­˜åœ¨
                if (appJsCode.includes('this.activeBlobUrls = new Set()')) {
                    log(testId, 'âœ“ æ‰¾åˆ° activeBlobUrls åˆå§‹åŒ–', 'success');
                    testsPassed++;
                } else {
                    log(testId, 'âœ— æœªæ‰¾åˆ° activeBlobUrls åˆå§‹åŒ–', 'error');
                }

                // æª¢æŸ¥ 2: revokeAllBlobUrls æ–¹æ³•å­˜åœ¨
                if (appJsCode.includes('revokeAllBlobUrls()')) {
                    log(testId, 'âœ“ æ‰¾åˆ° revokeAllBlobUrls() æ–¹æ³•', 'success');
                    testsPassed++;
                } else {
                    log(testId, 'âœ— æœªæ‰¾åˆ° revokeAllBlobUrls() æ–¹æ³•', 'error');
                }

                // æª¢æŸ¥ 3: renderHistoryList ä¸­å‘¼å« revokeAllBlobUrls
                if (appJsCode.includes('this.revokeAllBlobUrls()') &&
                    appJsCode.includes('renderHistoryList(results)')) {
                    log(testId, 'âœ“ renderHistoryList ä¸­å‘¼å« revokeAllBlobUrls', 'success');
                    testsPassed++;
                } else {
                    log(testId, 'âœ— renderHistoryList ä¸­æœªå‘¼å« revokeAllBlobUrls', 'error');
                }

                // ç¸½çµ
                if (testsPassed === totalTests) {
                    log(testId, `âœ… æ‰€æœ‰æª¢æŸ¥é€šé (${testsPassed}/${totalTests})`, 'success');
                    setStatus(testId, 'success', 'âœ“ æ¸¬è©¦é€šé');
                } else {
                    log(testId, `âš  éƒ¨åˆ†æª¢æŸ¥å¤±æ•— (${testsPassed}/${totalTests})`, 'warn');
                    setStatus(testId, 'error', `âœ— éƒ¨åˆ†æª¢æŸ¥å¤±æ•— (${testsPassed}/${totalTests})`);
                }

            } catch (error) {
                log(testId, `âœ— éŒ¯èª¤: ${error.message}`, 'error');
                setStatus(testId, 'error', 'âœ— æ¸¬è©¦å¤±æ•—');
            }
        }

        // æ¸¬è©¦ 3: Global Variable Check
        async function runTest3() {
            const testId = 'test3';
            setStatus(testId, 'running', 'æ¸¬è©¦é€²è¡Œä¸­...');
            log(testId, 'é–‹å§‹æª¢æŸ¥å…¨åŸŸè®Šæ•¸æ±¡æŸ“', 'info');

            try {
                // é€é fetch è®€å– app.js ç¨‹å¼ç¢¼ä¸¦æª¢æŸ¥
                const response = await fetch('../assets/js/app.js');
                const appJsCode = await response.text();

                let testsPassed = 0;
                let totalTests = 3;

                // æª¢æŸ¥ 1: ä¸æ‡‰æœ‰ "let app;" æˆ– "var app;" åœ¨å…¨åŸŸç¯„åœ
                if (!appJsCode.includes('let app;') && !appJsCode.includes('var app;')) {
                    log(testId, 'âœ“ æœªæ‰¾åˆ°å…¨åŸŸ app è®Šæ•¸å®£å‘Š', 'success');
                    testsPassed++;
                } else {
                    log(testId, 'âœ— æ‰¾åˆ°å…¨åŸŸ app è®Šæ•¸å®£å‘Š', 'error');
                }

                // æª¢æŸ¥ 2: ä¸æ‡‰æœ‰ onclick="app.xxx" çš„ inline handler
                if (!appJsCode.includes('onclick="app.')) {
                    log(testId, 'âœ“ æœªæ‰¾åˆ° inline onclick handler', 'success');
                    testsPassed++;
                } else {
                    log(testId, 'âœ— æ‰¾åˆ° inline onclick handler', 'error');
                }

                // æª¢æŸ¥ 3: æ‡‰ä½¿ç”¨äº‹ä»¶å§”æ´¾ (addEventListener with event delegation)
                if (appJsCode.includes('this.elements.historyList.addEventListener(\'click\'')) {
                    log(testId, 'âœ“ æ‰¾åˆ°äº‹ä»¶å§”æ´¾å¯¦ä½œ', 'success');
                    testsPassed++;
                } else {
                    log(testId, 'âœ— æœªæ‰¾åˆ°äº‹ä»¶å§”æ´¾å¯¦ä½œ', 'error');
                }

                // ç¸½çµ
                if (testsPassed === totalTests) {
                    log(testId, `âœ… æ‰€æœ‰æª¢æŸ¥é€šé (${testsPassed}/${totalTests})`, 'success');
                    setStatus(testId, 'success', 'âœ“ æ¸¬è©¦é€šé');
                } else {
                    log(testId, `âš  éƒ¨åˆ†æª¢æŸ¥å¤±æ•— (${testsPassed}/${totalTests})`, 'warn');
                    setStatus(testId, 'error', `âœ— éƒ¨åˆ†æª¢æŸ¥å¤±æ•— (${testsPassed}/${totalTests})`);
                }

            } catch (error) {
                log(testId, `âœ— éŒ¯èª¤: ${error.message}`, 'error');
                setStatus(testId, 'error', 'âœ— æ¸¬è©¦å¤±æ•—');
            }
        }

        // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
        async function runAllTests() {
            console.log('ğŸš€ é–‹å§‹åŸ·è¡Œæ‰€æœ‰ Critical Fixes æ¸¬è©¦');

            await runTest1();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runTest2();
            await new Promise(resolve => setTimeout(resolve, 500));

            await runTest3();

            console.log('âœ… æ‰€æœ‰æ¸¬è©¦åŸ·è¡Œå®Œæˆ');
            alert('æ‰€æœ‰æ¸¬è©¦åŸ·è¡Œå®Œæˆï¼è«‹æª¢æŸ¥çµæœã€‚');
        }
    </script>
</body>
</html>
