<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦ç­”æ¡ˆå¡ç”¢ç”Ÿå™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2rem;
            background: #f5f5f5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .controls {
            margin: 1rem 0;
            display: flex;
            gap: 1rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 1rem;
        }

        button:hover {
            background: #5568d3;
        }

        #canvas {
            border: 1px solid #ddd;
            display: block;
            margin: 1rem auto;
            background: white;
        }

        .answer-input {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .answer-input label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ æ¸¬è©¦ç­”æ¡ˆå¡ç”¢ç”Ÿå™¨</h1>
        <p>æ­¤å·¥å…·å¯ç”¢ç”Ÿæ¸¬è©¦ç”¨ç­”æ¡ˆå¡å½±åƒï¼Œç”¨æ–¼æ¸¬è©¦ OMR ç³»çµ±ã€‚</p>

        <div class="controls">
            <button onclick="generateBlankSheet()">ç”¢ç”Ÿç©ºç™½ç­”æ¡ˆå¡</button>
            <button onclick="generateFilledSheet()">ç”¢ç”Ÿå·²å¡«ç­”ç­”æ¡ˆå¡</button>
            <button onclick="downloadImage()">ä¸‹è¼‰ç­”æ¡ˆå¡</button>
        </div>

        <h3>å¿«é€Ÿå¡«ç­”ï¼ˆé»æ“Šç”¢ç”Ÿå°æ‡‰ç­”æ¡ˆå¡ï¼‰ï¼š</h3>
        <div class="answer-input">
            <button onclick="fillPattern('AAAA')">å…¨ Aï¼ˆå‰4é¡Œï¼‰</button>
            <button onclick="fillPattern('BBBB')">å…¨ Bï¼ˆå‰4é¡Œï¼‰</button>
            <button onclick="fillPattern('CCCC')">å…¨ Cï¼ˆå‰4é¡Œï¼‰</button>
            <button onclick="fillPattern('DDDD')">å…¨ Dï¼ˆå‰4é¡Œï¼‰</button>
            <button onclick="fillPattern('ABCD')">ABCD å¾ªç’°</button>
            <button onclick="fillPattern('RANDOM')">éš¨æ©Ÿå¡«ç­”</button>
        </div>

        <canvas id="canvas" width="850" height="1202"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // æ¨¡æ¿é…ç½®ï¼ˆèˆ‡ default-template.json ç›¸åŒï¼‰
        const config = {
            page: { width: 850, height: 1202 },
            bubbles: { diameter: 32 },
            layout: {
                regions: [
                    {
                        id: "questions_1_10",
                        origin: { x: 100, y: 300 },
                        questions: { start: 1, end: 10, gap: 65 },
                        options: { values: ["A", "B", "C", "D"], gap: 80 }
                    },
                    {
                        id: "questions_11_20",
                        origin: { x: 500, y: 300 },
                        questions: { start: 11, end: 20, gap: 65 },
                        options: { values: ["A", "B", "C", "D"], gap: 80 }
                    }
                ]
            }
        };

        // ç”¢ç”Ÿç©ºç™½ç­”æ¡ˆå¡
        function generateBlankSheet() {
            // èƒŒæ™¯
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // æ¨™é¡Œ
            ctx.fillStyle = 'black';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('OMR æ¸¬è©¦ç­”æ¡ˆå¡', canvas.width / 2, 100);

            // èªªæ˜
            ctx.font = '18px Arial';
            ctx.fillText('20 é¡Œå››é¸ä¸€æ¸¬è©¦', canvas.width / 2, 150);

            // ç¹ªè£½é¡Œç›®å’Œé¸é …
            drawAllBubbles(false);

            // ç¹ªè£½å››å€‹è§’è½æ¨™è¨˜ï¼ˆç”¨æ–¼é€è¦–æ ¡æ­£ï¼‰
            drawCornerMarkers();
        }

        // ç”¢ç”Ÿå·²å¡«ç­”ç­”æ¡ˆå¡
        function generateFilledSheet() {
            generateBlankSheet();

            // æ ¹æ“šé è¨­ç­”æ¡ˆå¡«å……
            const answers = {
                1: 'A', 2: 'B', 3: 'C', 4: 'D', 5: 'A',
                6: 'B', 7: 'C', 8: 'D', 9: 'A', 10: 'B',
                11: 'C', 12: 'D', 13: 'A', 14: 'B', 15: 'C',
                16: 'D', 17: 'A', 18: 'B', 19: 'C', 20: 'D'
            };

            fillBubbles(answers);
        }

        // ç¹ªè£½æ‰€æœ‰æ¨™è¨˜åœ“åœˆ
        function drawAllBubbles(filled = false) {
            config.layout.regions.forEach(region => {
                const { origin, questions, options } = region;

                for (let q = questions.start; q <= questions.end; q++) {
                    const questionIndex = q - questions.start;
                    const y = origin.y + (questionIndex * questions.gap);

                    // é¡Œè™Ÿ
                    ctx.fillStyle = 'black';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'right';
                    ctx.fillText(`${q}.`, origin.x - 20, y + 5);

                    // é¸é …æ¨™è¨˜
                    options.values.forEach((option, optionIndex) => {
                        const x = origin.x + (optionIndex * options.gap);

                        // é¸é …å­—æ¯
                        ctx.textAlign = 'center';
                        ctx.font = 'bold 14px Arial';
                        ctx.fillText(option, x, y - 25);

                        // ç•«åœ“åœˆ
                        ctx.beginPath();
                        ctx.arc(x, y, config.bubbles.diameter / 2, 0, 2 * Math.PI);
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = 2;
                        ctx.stroke();

                        if (filled) {
                            ctx.fillStyle = 'black';
                            ctx.fill();
                        }
                    });
                }
            });
        }

        // å¡«å……ç‰¹å®šç­”æ¡ˆ
        function fillBubbles(answers) {
            config.layout.regions.forEach(region => {
                const { origin, questions, options } = region;

                for (let q = questions.start; q <= questions.end; q++) {
                    const answer = answers[q];
                    if (!answer) continue;

                    const questionIndex = q - questions.start;
                    const y = origin.y + (questionIndex * questions.gap);

                    const optionIndex = options.values.indexOf(answer);
                    if (optionIndex === -1) continue;

                    const x = origin.x + (optionIndex * options.gap);

                    // å¡«å……åœ“åœˆ
                    ctx.beginPath();
                    ctx.arc(x, y, config.bubbles.diameter / 2 - 3, 0, 2 * Math.PI);
                    ctx.fillStyle = 'black';
                    ctx.fill();
                }
            });
        }

        // ç¹ªè£½å››å€‹è§’è½æ¨™è¨˜
        function drawCornerMarkers() {
            const markerSize = 40;
            const offset = 50;

            ctx.fillStyle = 'black';

            // å·¦ä¸Š
            ctx.fillRect(offset, offset, markerSize, markerSize);

            // å³ä¸Š
            ctx.fillRect(canvas.width - offset - markerSize, offset, markerSize, markerSize);

            // å·¦ä¸‹
            ctx.fillRect(offset, canvas.height - offset - markerSize, markerSize, markerSize);

            // å³ä¸‹
            ctx.fillRect(canvas.width - offset - markerSize, canvas.height - offset - markerSize, markerSize, markerSize);
        }

        // å¡«ç­”æ¨¡å¼
        function fillPattern(pattern) {
            generateBlankSheet();

            const answers = {};

            if (pattern === 'RANDOM') {
                const options = ['A', 'B', 'C', 'D'];
                for (let i = 1; i <= 20; i++) {
                    answers[i] = options[Math.floor(Math.random() * 4)];
                }
            } else if (pattern === 'ABCD') {
                const options = ['A', 'B', 'C', 'D'];
                for (let i = 1; i <= 20; i++) {
                    answers[i] = options[(i - 1) % 4];
                }
            } else {
                // AAAA, BBBB, CCCC, DDDD
                const option = pattern[0];
                for (let i = 1; i <= 20; i++) {
                    answers[i] = option;
                }
            }

            fillBubbles(answers);
        }

        // ä¸‹è¼‰ç­”æ¡ˆå¡
        function downloadImage() {
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'test-answer-sheet.jpg';
                a.click();
                URL.revokeObjectURL(url);
            }, 'image/jpeg', 0.95);
        }

        // åˆå§‹åŒ–ï¼šç”¢ç”Ÿç©ºç™½ç­”æ¡ˆå¡
        generateBlankSheet();
    </script>
</body>
</html>
