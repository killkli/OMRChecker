# Stage 3: 輪廓檢測與透視校正 - 測試指南

## 功能概述

Stage 3 實現了答案卡邊界檢測和自動透視校正功能，包含以下核心功能：

1. **Canny 邊緣檢測** - 偵測影像中的邊緣
2. **輪廓查找** - 找到所有封閉輪廓
3. **四邊形輪廓篩選** - 根據面積和形狀篩選出答案卡
4. **角點排序** - 將四個角點排序為左上、右上、右下、左下
5. **透視變換** - 將傾斜的答案卡校正為正面視角
6. **視覺化** - 在原圖上標記檢測到的角點和輪廓

---

## 快速開始

### 1. 啟動本地伺服器

```bash
cd /Users/johnchen/AICoding/OMRChecker/serverless_web
python3 -m http.server 8000
```

### 2. 開啟測試頁面

**主應用程式測試：**
- URL: http://localhost:8000/
- 上傳答案卡影像，系統會自動執行透視校正

**單元測試頁面：**
- URL: http://localhost:8000/tests/test-contour-detection.html
- 提供獨立的測試環境，可逐項測試各個功能

---

## 測試案例

### Test Case 1: 基本輪廓檢測

**目的：** 驗證系統能正確檢測出答案卡的四個角點

**步驟：**
1. 上傳測試影像 `samples/test-sheet.jpg`
2. 檢查「角點檢測」Canvas 是否顯示綠色圓點標記四個角點
3. 檢查藍色線條是否連接四個角點形成矩形

**預期結果：**
- ✅ 檢測到 4 個角點
- ✅ 角點位置準確（對應答案卡四個角）
- ✅ 視覺化正確顯示

---

### Test Case 2: 透視校正（0° 正面）

**目的：** 驗證系統對正面拍攝的答案卡也能正確處理

**步驟：**
1. 上傳正面拍攝的答案卡
2. 檢查「透視校正」Canvas

**預期結果：**
- ✅ 輸出影像為 850x1202 (A4 比例)
- ✅ 答案卡邊界與 Canvas 邊界平行
- ✅ 無明顯變形

---

### Test Case 3: 透視校正（15° 傾斜）

**目的：** 驗證系統能校正輕微傾斜的答案卡

**步驟：**
1. 上傳 15° 傾斜的答案卡影像
2. 檢查校正結果

**預期結果：**
- ✅ 角點正確檢測
- ✅ 校正後的答案卡為正面視角
- ✅ 邊界平行於 Canvas

---

### Test Case 4: 透視校正（30° 傾斜）

**目的：** 驗證系統能校正中度傾斜的答案卡

**步驟：**
1. 準備或模擬 30° 傾斜的答案卡
2. 上傳並檢查校正結果

**預期結果：**
- ✅ 角點正確檢測
- ✅ 透視變換正確應用
- ✅ 校正後答案卡清晰可讀

---

### Test Case 5: 透視校正（45° 傾斜）

**目的：** 驗證系統能處理大角度傾斜

**步驟：**
1. 準備或模擬 45° 傾斜的答案卡
2. 上傳並檢查校正結果

**預期結果：**
- ✅ 能檢測到答案卡輪廓
- ✅ 透視變換成功
- ✅ 校正後影像無嚴重失真

---

### Test Case 6: 錯誤處理 - 找不到答案卡

**目的：** 驗證系統能正確處理無效影像

**步驟：**
1. 上傳不包含答案卡的影像（例如風景照）
2. 檢查錯誤訊息

**預期結果：**
- ❌ 顯示錯誤：「未找到答案卡輪廓，請確保答案卡完整且清晰可見」
- ✅ 不會崩潰
- ✅ 顯示基礎處理結果（灰階、二值化等）

---

### Test Case 7: 錯誤處理 - 部分遮擋

**目的：** 驗證系統能處理部分遮擋的答案卡

**步驟：**
1. 上傳部分被遮擋的答案卡影像
2. 檢查系統行為

**預期結果：**
- ⚠️ 可能檢測失敗或檢測到錯誤輪廓
- ✅ 顯示適當的錯誤訊息
- ✅ 不會崩潰

---

### Test Case 8: 不同光照條件

**目的：** 驗證系統在不同光照下的穩定性

**測試影像：**
- 明亮光照
- 昏暗光照
- 側光（強陰影）

**預期結果：**
- ✅ 各種光照條件下都能檢測到輪廓
- ✅ 自適應二值化有效處理光照不均

---

## 單元測試（test-contour-detection.html）

### 使用方式

1. 開啟 `http://localhost:8000/tests/test-contour-detection.html`
2. 點擊「上傳測試影像」
3. 選擇測試影像
4. 系統會自動執行所有測試案例

### 測試項目

1. ✅ **Canny 邊緣檢測測試**
   - 驗證 `cannyEdgeDetection()` 方法
   - 檢查返回的邊緣影像不為空

2. ✅ **輪廓查找測試**
   - 驗證 `findContours()` 方法
   - 確認找到多個輪廓

3. ✅ **四邊形輪廓篩選測試**
   - 驗證 `filterQuadrilateralContours()` 方法
   - 確認能篩選出四邊形

4. ✅ **角點排序測試**
   - 驗證 `orderCorners()` 方法
   - 使用預定義的測試點
   - 確認返回順序為：左上、右上、右下、左下

5. ✅ **透視變換矩陣測試**
   - 驗證 `getPerspectiveTransform()` 方法
   - 確認返回 3x3 矩陣

6. ✅ **完整透視校正測試**
   - 驗證 `correctPerspective()` 方法
   - 確認返回校正後影像、角點和視覺化

---

## 檢查清單

使用以下清單確保所有功能都已測試：

### 功能測試
- [ ] Canny 邊緣檢測運作正常
- [ ] 輪廓查找能找到所有輪廓
- [ ] 四邊形輪廓篩選正確
- [ ] 角點排序演算法準確
- [ ] 透視變換矩陣計算正確
- [ ] 透視校正應用成功
- [ ] 視覺化（角點標記）正確顯示

### 角度測試
- [ ] 0° (正面) 答案卡校正正確
- [ ] 15° 傾斜答案卡校正正確
- [ ] 30° 傾斜答案卡校正正確
- [ ] 45° 傾斜答案卡校正正確

### 錯誤處理
- [ ] 找不到答案卡時顯示錯誤訊息
- [ ] 部分遮擋時正確處理
- [ ] 系統不會崩潰

### 光照條件
- [ ] 明亮光照下正常運作
- [ ] 昏暗光照下正常運作
- [ ] 強陰影下正常運作

### 記憶體管理
- [ ] 所有 Mat 物件都被正確清理
- [ ] 無記憶體洩漏

### UI/UX
- [ ] 處理過程有適當的進度提示
- [ ] 錯誤訊息清晰易懂
- [ ] Canvas 顯示正確
- [ ] 響應式設計正常

---

## 已知限制

1. **最小面積限制：** 答案卡必須佔影像面積的 20% 以上
2. **四邊形假設：** 假設答案卡為四邊形，其他形狀可能無法檢測
3. **單一答案卡：** 目前只處理最大的四邊形輪廓
4. **完整可見：** 答案卡四個角必須完整可見

---

## 疑難排解

### 問題：找不到答案卡輪廓

**可能原因：**
- 答案卡太小（佔畫面比例 < 20%）
- 答案卡不完整（邊緣被裁切）
- 光照太差，邊緣不清晰

**解決方案：**
- 確保答案卡佔據畫面大部分區域
- 確保四個角都在畫面內
- 提高光照，避免強烈陰影

---

### 問題：角點檢測不準確

**可能原因：**
- 背景雜亂，有其他矩形物體
- 答案卡邊緣模糊

**解決方案：**
- 使用純色背景
- 確保答案卡邊界清晰
- 調整 `minAreaRatio` 參數（目前為 0.2）

---

### 問題：透視校正後影像變形

**可能原因：**
- 角點檢測錯誤
- 輸出尺寸比例設定不當

**解決方案：**
- 檢查視覺化，確認角點位置正確
- 調整輸出尺寸（目前為 A4 比例）

---

## 效能指標

在一般電腦上的預期效能：

- **影像載入：** < 0.5 秒
- **預處理（灰階、模糊、二值化）：** < 0.5 秒
- **邊緣檢測與輪廓查找：** < 1 秒
- **透視校正：** < 1 秒
- **總處理時間：** < 3 秒

---

## 下一階段預告

**Stage 4 將實現：**
- 答案標記（圓形/方形）檢測
- 填充率計算
- 答案解析與評分

**需要的輸入：**
- 校正後的答案卡影像（來自 Stage 3）
- 答案模板配置檔

---

## 開發者筆記

### 程式碼架構

所有 Stage 3 功能都在 `ImageProcessor` 類別中：

```javascript
// 核心方法
cannyEdgeDetection(src, threshold1, threshold2)
findContours(binary)
filterQuadrilateralContours(contours, imageArea, minAreaRatio)
orderCorners(points)
getPerspectiveTransform(srcPoints, dstPoints)
applyPerspectiveTransform(src, M, width, height)
correctPerspective(src)  // 主要入口
```

### 記憶體管理

- 所有建立的 Mat 都會被追蹤在 `processedMats` 陣列
- `cleanup()` 方法負責釋放所有 Mat
- 中間結果在函式內部立即清理

### 參數調整

可調整的關鍵參數：

```javascript
// Canny 閾值
threshold1 = 50   // 降低以檢測更多邊緣
threshold2 = 150  // 提高以減少雜訊

// 最小面積比例
minAreaRatio = 0.2  // 調整以篩選不同大小的答案卡

// 多邊形逼近係數
approxEpsilon = 0.02 * perimeter  // 調整以改變輪廓精度

// 輸出尺寸
outputWidth = 850
outputHeight = 1202 (A4 比例)
```

---

**文件版本：** v1.0
**建立日期：** 2025-10-05
**作者：** engineer-agent
**狀態：** Stage 3 Complete
