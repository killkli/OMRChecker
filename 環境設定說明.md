# 環境設定說明

本專案使用 [uv](https://github.com/astral-sh/uv) 進行 Python 環境和依賴管理，確保在任何機器上都能快速且一致地建立開發環境。

## 📋 系統需求

- **Python**: 3.12 或更高版本
- **uv**: 最新版本（推薦使用）
- **作業系統**: macOS、Linux 或 Windows

## 🚀 快速開始

### 1. 安裝 uv

#### macOS / Linux
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

#### Windows
```powershell
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

#### 使用 pip（替代方案）
```bash
pip install uv
```

### 2. Clone 專案
```bash
git clone https://github.com/Udayraj123/OMRChecker.git
cd OMRChecker
```

### 3. 建立虛擬環境並安裝依賴

**只需一個指令！**
```bash
uv sync
```

這個指令會：
- ✅ 自動偵測並使用 Python 3.12（根據 `.python-version`）
- ✅ 建立虛擬環境在 `.venv/` 目錄
- ✅ 安裝所有專案依賴（根據 `pyproject.toml`）
- ✅ 安裝開發依賴（black, flake8, pytest 等）
- ✅ 產生 `uv.lock` 鎖定檔案（確保依賴版本一致）

### 4. 啟動虛擬環境

#### macOS / Linux
```bash
source .venv/bin/activate
```

#### Windows
```powershell
.venv\Scripts\activate
```

### 5. 驗證安裝

```bash
# 檢查 Python 版本
python --version
# 應該顯示：Python 3.12.x

# 檢查已安裝的套件
uv pip list

# 測試 Gradio 界面
cd frontend
python app.py
```

瀏覽器開啟：http://localhost:7860

---

## 📦 依賴管理

### 新增依賴套件

**方法 1：使用 uv add（推薦）**
```bash
# 新增正式依賴
uv add package-name

# 新增開發依賴
uv add --dev package-name

# 新增特定版本
uv add "package-name>=1.0.0"
```

**方法 2：手動編輯 pyproject.toml**
1. 編輯 `pyproject.toml`，在 `dependencies` 或 `dev-dependencies` 加入套件
2. 執行 `uv sync` 更新環境

### 更新依賴

```bash
# 更新所有套件到最新版本
uv sync --upgrade

# 更新特定套件
uv add --upgrade package-name
```

### 移除依賴

```bash
uv remove package-name
```

---

## 🔧 常用指令

### 環境管理

```bash
# 重新同步環境（安裝缺少的依賴）
uv sync

# 清理並重建環境
rm -rf .venv uv.lock
uv sync

# 只安裝正式依賴（不含開發依賴）
uv sync --no-dev
```

### 執行指令

```bash
# 在虛擬環境中執行 Python
uv run python script.py

# 執行 Gradio 界面（不需要 activate）
uv run python frontend/app.py

# 執行測試
uv run pytest

# 格式化程式碼
uv run black .
uv run isort .
```

### 套件管理

```bash
# 列出已安裝套件
uv pip list

# 檢查套件資訊
uv pip show package-name

# 搜尋套件
uv pip search package-name

# 匯出依賴清單
uv pip freeze > requirements.txt
```

---

## 📝 專案檔案說明

### pyproject.toml
- 專案配置檔案（PEP 621 標準）
- 定義專案名稱、版本、依賴等
- 包含 black、isort、pytest 等工具設定

### .python-version
- 指定專案使用的 Python 版本（3.12）
- uv 會自動使用此版本

### uv.lock
- 依賴鎖定檔案（類似 package-lock.json）
- 確保所有機器使用相同的依賴版本
- **應該 commit 到 git**

### .venv/
- 虛擬環境目錄
- 由 `.gitignore` 排除（不 commit）
- 可以隨時刪除並用 `uv sync` 重建

---

## 🐛 疑難排解

### 問題 1：找不到 Python 3.12

**錯誤訊息：**
```
error: No interpreter found for Python 3.12
```

**解決方法：**
```bash
# 安裝 Python 3.12
# macOS (使用 Homebrew)
brew install python@3.12

# Ubuntu/Debian
sudo apt install python3.12

# 或讓 uv 自動下載
uv python install 3.12
```

### 問題 2：uv sync 失敗

**解決方法：**
```bash
# 清理快取
uv cache clean

# 刪除舊環境重新同步
rm -rf .venv uv.lock
uv sync
```

### 問題 3：套件版本衝突

**解決方法：**
```bash
# 更新 uv.lock
uv lock --upgrade

# 重新同步
uv sync
```

### 問題 4：中文字體問題

**解決方法：**
```bash
# 複製中文字體到專案（參考 fonts/README.md）
cp ~/Library/Fonts/edukai-4.0.ttf fonts/TW-Kai.ttf
```

---

## 🔄 從舊環境遷移

### 從 pip + requirements.txt 遷移

如果你之前使用 pip 和 `requirements.txt`：

```bash
# 1. 停用舊環境
deactivate

# 2. 刪除舊 venv（可選）
rm -rf venv/

# 3. 使用 uv 建立新環境
uv sync

# 4. 啟動新環境
source .venv/bin/activate
```

舊的 `requirements.txt` 已經被整合到 `pyproject.toml` 中。

---

## 💡 最佳實踐

1. **永遠使用 `uv sync`**
   - Clone 專案後第一件事：`uv sync`
   - 切換分支後：`uv sync`
   - Pull 最新程式碼後：`uv sync`

2. **Commit `uv.lock`**
   - 確保團隊使用相同的依賴版本
   - 避免「在我的機器上可以執行」的問題

3. **使用 `uv run`**
   - 不需要手動 activate 虛擬環境
   - 自動使用專案的虛擬環境

4. **定期更新依賴**
   ```bash
   uv sync --upgrade
   ```

5. **開發前檢查環境**
   ```bash
   uv sync  # 確保環境是最新的
   uv run pytest  # 執行測試確認一切正常
   ```

---

## 🚀 進階用法

### 多個 Python 版本

```bash
# 安裝特定版本
uv python install 3.11 3.12 3.13

# 使用特定版本
uv venv --python 3.11

# 切換版本
echo "3.11" > .python-version
uv sync
```

### 自訂虛擬環境位置

```bash
# 使用不同的 venv 目錄
uv venv custom-venv
source custom-venv/bin/activate
uv sync
```

### CI/CD 整合

```yaml
# GitHub Actions 範例
- name: Setup uv
  run: curl -LsSf https://astral.sh/uv/install.sh | sh

- name: Install dependencies
  run: uv sync --no-dev

- name: Run tests
  run: uv run pytest
```

---

## 📚 參考資源

- **uv 官方文件**: https://docs.astral.sh/uv/
- **uv GitHub**: https://github.com/astral-sh/uv
- **Python 打包指南**: https://packaging.python.org/
- **PEP 621**: https://peps.python.org/pep-0621/

---

## ✅ 檢查清單

安裝完成後，確認以下項目：

- [ ] `uv --version` 有輸出版本號
- [ ] `python --version` 顯示 Python 3.12.x
- [ ] `uv pip list` 顯示所有套件
- [ ] `.venv/` 目錄存在
- [ ] `uv.lock` 檔案存在
- [ ] `uv run python frontend/app.py` 可以啟動 Gradio 界面
- [ ] http://localhost:7860 可以開啟網頁

全部打勾表示環境設定成功！🎉
